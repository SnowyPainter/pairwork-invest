# M002 모델

매수자 모델과 매도자 모델로 나누어진다.
매수자 모델의 라벨 기준
MACD 변화율이 미미하면서 볼린저 밴드 하단이 급격히 하락하는 패턴 -> 매수 신호
e.g. 신고가를 돌파하기 직전, 과매도 구간에서 매수세가 붙는 상황

매도자 모델
EMA/SMA 변동이 적고 ATR이 상승하는 경우 -> 매도 신호
e.g. 신고가 이후 시장 안정성이 깨지고 변동성이 커지는 구간

## 복각 제안

### 브레이크아웃 기준점
- **정의**: N일 신고가/신저가 돌파 직전/직후 윈도우를 명시
- **예시**: 직전 20일 고점 돌파 ±5거래일

### 매수 라벨 (y_buy)

**조건 1**: MACD 변화율 평탄화
- `|ΔMACD| < ε` (평탄)

**조건 2**: 볼린저 밴드 하단 과도 이탈
- `BBand_low z-score < −z₁` (하단 과도 이탈)

**조건 3**: 수익률 조건
- 이후 H일 내 `최고가/진입가 ≥ +τ_up` (예: +5%)
- **결과**: 충족 시 `1`, 아니면 `0`

### 매도 라벨 (y_sell)

**조건 1**: EMA/SMA 스프레드 평탄화
- EMA/SMA 스프레드의 기울기 ≈ 0 (평탄)

**조건 2**: ATR 상승률 조건
- `ΔATR/ATR_prev ≥ α`

**조건 3**: 손실률 조건
- 이후 H일 내 `최저가/진입가 ≤ −τ_dn` (예: −5%)
- **결과**: 충족 시 `1`, 아니면 `0`

### 샘플링·불균형 대책 (SMOTE 대체)

시계열에선 시점 일관성과 공변량 이동 문제가 큼. 대안:

1. Time-aware undersampling: 동일 날짜 안에서 이벤트 비율을 상한(예: 1:5)으로 제어.

2. 클래스-밸런스드 로스(Effective Number of Samples), Focal Loss/Asymmetric Loss.

3. Threshold moving + Calibration(아래 4장) 조합.

3) LSTM 대체: 더 나은 아키텍처

### 대안 아키텍처

#### A. TCN (Temporal Convolutional Network)

**장점**: 
- 병렬화 및 빠른 학습
- 장기 의존성 확보 (팽창 컨볼루션)
- 라벨이 이벤트성일 때 변동성 스파이크 포착에 강함

**구현 팁**:
- 가변 리셉티브 필드 (예: 16–128)
- 그룹 노름 + 드롭아웃
- Quantile Head (위험 한계 추정) 추가

#### B. TFT/Informer류 (경량 Transformer)

**장점**:
- 다중 호라이즌 예측
- 변수 주의(attention)로 지표별 중요도 해석 가능

**구현 팁**:
- 피처 수가 많으면 가변 선택 게이팅(Variable Selection Network) 활성화
- 데이터가 적으면 프리텍스트(Self-Supervised) 방식 활용
  - 마스킹·시점 셔플 복원으로 사전학습 후 파인튜닝

#### C. "시계열→탭" 전략 (강력 추천)

**접근법**:
윈도우 집계 특징 엔지니어링 → LightGBM/XGBoost/NGBoost로 이진 분류

**집계 특징 예시**:
- 롤링 수치
- 익스트림 지표
- 파동성/곡률
- 브레이크아웃 거리 등

**장점**:
- 튜닝 용이 및 빠른 학습
- 정확도 준수
- Top-K 랭킹/확률 보정이 쉬움

**하이브리드 접근**:
TCN encoder → GBDT head (embedding 추출 후 트리로 최종 분류)

#### D. N-BEATS/DeepAR (대안)

**특징**:
- 방향성보다는 레벨 예측에 강함
- 이벤트 탐지 목적이면 TCN/트랜스포머/GBDT가 대체로 유리

### 캘리브레이션 & Top-K 운용

#### A. 캘리브레이션

**확률 보정 방법**:
- **플랫 스케일링(로지스틱)**: 워크포워드 폴드별로 적합하여 실전 분포 격차 보정
- **아이소토닉 회귀**: 비선형 보정으로 더 정교한 확률 조정
- **템퍼러처 스케일링**: 모델이 과확신일 때 적용

**검증 방법**:
- 예측-실현 리프트 차트로 상위 확률 구간에서의 승률·익스트림 손익을 점검
- 캘리브레이션 곡선으로 예측 확률과 실제 확률의 일치도 확인

#### B. Top-K 선택 ("캘리브 실패" 시 안전장치)

일자별로 합성 점수 = P(event)ᵅ × P(방향)ᵝ × W(유동성/스프레드/체결확률)

ᵅ,ᵝ는 0.5~1.5 탐색(너가 쓰던 score 구조와 합침 가능).

K 동적화:

기준: 예측 확률이 임계 p* 이상인 종목만 채택(예: precision@K ≥ 목표치일 때만 K 확장).

CV로 p*, K*를 공동 탐색(예: 월별 리밸런싱 윈도우에서 Max Sharpe 또는 Max Calmar).

컨포멀(Conformal) 임계: 불확실성 추정(예: 로지스틱 분산/MC dropout)으로 예측셋 범위를 사용 → 불확실성 큰 종목은 Top-K에서 제외.